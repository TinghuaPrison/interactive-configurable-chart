<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Trial </title>

    <script>
        // 布局相关的变量
        var canvasWidth = 1200;                             // 暂定的画布宽度
        const canvasHeight = 600;                           // 暂定的画布高度
        var baseDataNum = 10;                               // x 轴初始长度最多容纳的数据量
        var barWidth = 36;                                  // 设计的 bar 宽度（用于估算 x 轴长度，实际可视情况而定）
        var barSpace = 20;                                  // 设计的 bar 间距（用于估算 x 轴长度，实际可视情况而定）
        var xAxisLength = baseDataNum * barWidth + (baseDataNum + 1) * barSpace;   // x 轴的长度
        const yAxisBoxHeight = 80;                          // y 轴各格的高度
        const yAxisBoxNum = 6;                              // y 轴平分的格数
        const yAxisLength = yAxisBoxHeight * yAxisBoxNum;   // y 轴的长度                       
        var padLeft = (canvasWidth - xAxisLength) / 2;      // 画布最左侧到x轴最左侧的距离
        var padTop = (canvasHeight - yAxisLength) / 2;      // 画布最上面到y轴最上面的距离
        var halfScaleLength = 4;                            // x 轴和 y 轴刻度线的一半的长度
        var prevXAxisBoxWidth;                              // 数据量达到 baseDataNum 时 x 轴刻度线的间距
        var xAxisBoxWidth;

        // ==============================
        // 数据相关的变量
        var dataCount = 0;                 // chart 中数据的数量
        var dataYear = new Array();        // 依序记录输入的年份（下标从1开始）
        var dataProduction = new Array();  // 依序记录输入的产量（下标从1开始，和年份一一对应）***目前还没有用到这个数据，不过可能后面绘图会用到就一起写了
        var maxProduction;                 // 输入数据中的最大产量
        var minProduction;                 // 输入数据中的最小产量
        var originNumber = 0;              // y 轴的原点值
        var increaseNumber;                // y 轴刻度的增长值
        var transformedMaxProduction;      // y 轴原点变换后，最大值新坐标的位置在旧坐标的位置

        // ==============================
        // 绘制坐标轴的 L
        function drawL() {
            var drawingArea = document.getElementById('drawingArea');
            var drawingPen = drawingArea.getContext('2d');
            // ====================
            drawingPen.beginPath();
            // 绘制 y 轴和 x 轴
            drawingPen.moveTo(padLeft, padTop);
            drawingPen.lineTo(padLeft, padTop + yAxisLength);
            drawingPen.lineTo(padLeft + xAxisLength, padTop + yAxisLength);
            // 绘制 y 轴的箭头
            drawingPen.moveTo(padLeft, padTop);
            drawingPen.lineTo(padLeft - 4, padTop + 6);
            drawingPen.moveTo(padLeft, padTop);
            drawingPen.lineTo(padLeft + 4, padTop + 6);
            // 绘制 x 轴的箭头
            drawingPen.moveTo(padLeft + xAxisLength, padTop + yAxisLength);
            drawingPen.lineTo(padLeft + xAxisLength - 6, padTop + yAxisLength - 4);
            drawingPen.moveTo(padLeft + xAxisLength, padTop + yAxisLength);
            drawingPen.lineTo(padLeft + xAxisLength - 6, padTop + yAxisLength + 4)
            drawingPen.stroke();
            drawingPen.closePath();
        }

        // 绘制 y 轴的刻度线
        function drawYScale() {
            var drawingArea = document.getElementById('drawingArea');
            var drawingPen = drawingArea.getContext('2d');
            var lineNum = yAxisBoxNum - 1;
            // ====================
            drawingPen.beginPath();
            for (var i = 1; i <= lineNum; ++i) {
                drawingPen.moveTo(padLeft - halfScaleLength, padTop + i * yAxisBoxHeight);
                drawingPen.lineTo(padLeft + halfScaleLength, padTop + i * yAxisBoxHeight);
            }
            drawingPen.stroke();
            drawingPen.closePath();
        }

        // 绘制坐标轴的标题
        function drawAxisTitle() {
            var drawingArea = document.getElementById('drawingArea');
            var drawingPen = drawingArea.getContext('2d');
            // ====================
            drawingPen.font = "18px Arial";
            drawingPen.fillText("产量 (万吨)", padLeft - 40, padTop - 12);
            drawingPen.fillText("年份", padLeft + xAxisLength + 8, padTop + yAxisLength + 5)
        }

        // 往 chart 中增加一个数据点
        function addData() {

            // 从输入框中获取输入的数据
            var yearInputBox = document.getElementById('year');
            var productionInputBox = document.getElementById('production');
            var curInputYear = yearInputBox.value;
            var curInputProduction = productionInputBox.value;

            // 若其中一个输入为空，不进行处理
            if (!curInputYear || !curInputProduction) {
                return;
            }

            // 若输入有效，数据数量+1，把数据记录到数组中
            dataCount += 1;
            dataYear[dataCount] = curInputYear;
            dataProduction[dataCount] = curInputProduction;

            // 若当前数据是最大值或最小值，更新记录
            if (dataCount != 1) {
                var curProductionValue = parseFloat(curInputProduction);
                if (curProductionValue < minProduction) {
                    minProduction = curProductionValue;
                }
                if (curProductionValue > maxProduction) {
                    maxProduction = curProductionValue;
                }
            }
            // 若是首次录入数据，同时将其设为最大值和最小值
            else {
                var curProductionValue = parseFloat(curInputProduction);
                minProduction = curProductionValue;
                maxProduction = curProductionValue;
            }

            // 绘制 x 轴（含清除画布操作）和 y 轴刻度
            updateXScale();
            updateYScale();


            // 重绘画布其他部分
            drawL();
            drawYScale();
            drawAxisTitle();
            updateBar();

            // 清空输入框的内容，debug时为方便起见暂时注释
            yearInputBox.value = "";
            productionInputBox.value = "";
        }

        // 调整及更新 x 轴的刻度显示
        function updateXScale() {
            var drawingArea = document.getElementById('drawingArea');
            var drawingPen = drawingArea.getContext('2d');
            // ====================
            // 先清除画布，重新绘制内容
            drawingPen.clearRect(0, 0, drawingArea.width, drawingArea.height);

            // 计算 x 轴刻度之间的间距
            // 当数据量 <= 10 时，间距取 x 轴长度的平均
            if (dataCount <= baseDataNum) {
                xAxisBoxWidth = xAxisLength / (dataCount + 1)
            }
            // 当数据量 (10, 19] 时，间距为数据量 = 10 时的间距，动态增加 x 轴长度
            else if (dataCount <= 19) {
                if (dataCount == baseDataNum + 1) {
                    prevXAxisBoxWidth = xAxisLength / (baseDataNum + 1);
                }
                xAxisLength += prevXAxisBoxWidth;
                xAxisBoxWidth = xAxisLength / (dataCount + 1)
                padLeft = (canvasWidth - xAxisLength) / 2;
                padTop = (canvasHeight - yAxisLength) / 2;
            }
            // 当数据量 > 19 时，
            else {
                // 直接加宽画布的方法
                canvasWidth += prevXAxisBoxWidth;
                drawingArea.width = canvasWidth;
                xAxisLength += prevXAxisBoxWidth;
                xAxisBoxWidth = xAxisLength / (dataCount + 1)
                padLeft = (canvasWidth - xAxisLength) / 2;
                padTop = (canvasHeight - yAxisLength) / 2;
            }

            // 绘制刻度和年份
            drawingPen.beginPath();
            for (var i = 1; i <= dataCount; ++i) {
                drawingPen.moveTo(padLeft + i * xAxisBoxWidth, padTop + yAxisLength - halfScaleLength);
                drawingPen.lineTo(padLeft + i * xAxisBoxWidth, padTop + yAxisLength + halfScaleLength);
                drawingPen.font = "12px Arial";
                drawingPen.fillText(dataYear[i], padLeft + i * xAxisBoxWidth - 13, padTop + yAxisLength + 15);
            }
            drawingPen.stroke();
            drawingPen.closePath();
        }

        // 计算及更新 y 轴的刻度值
        function updateYScale() {
            // 检验最大值和最小值是否差距太小
            var diffPercentage = (maxProduction - minProduction) / maxProduction;

            // 若达到触发条件，动态改变原点值
            if (0 < diffPercentage && diffPercentage <= 0.6) {
                var x = (0.6 * minProduction - 1) / 0.6;
                var newOriginNumber = Math.floor(x);
                originNumber = newOriginNumber;
                transformedMaxProduction = maxProduction - newOriginNumber;
            }
            // 否则，原点值默认为0
            else {
                originNumber = 0;
                transformedMaxProduction = maxProduction;
            }

            // 计算 y 轴刻度的增长值
            var divFlo = transformedMaxProduction / 5;
            var divInt = Math.floor(divFlo);
            var diff = divFlo - divInt;
            // ====================
            if (diff == 0) {
                increaseNumber = divInt;
            }
            else if (diff <= 0.5) {
                increaseNumber = divInt + 0.5;
            }
            else {
                increaseNumber = divInt + 1;
            }

            // 绘制刻度值
            var drawingArea = document.getElementById('drawingArea');
            var drawingPen = drawingArea.getContext('2d');
            // ====================
            drawingPen.beginPath();
            for (var i = 0; i < yAxisBoxNum; ++i) {
                drawingPen.font = "12px Arial";
                var txt = originNumber + i * increaseNumber;
                var txtWidth = drawingPen.measureText(txt).width;
                drawingPen.fillText(txt, padLeft - 7 - txtWidth, padTop + yAxisLength - i * yAxisBoxHeight + 5);
            }
            drawingPen.stroke();
            drawingPen.closePath();
        }

        // 显示柱状图的 bar
        function updateBar() {
            var drawingArea = document.getElementById('drawingArea');
            var drawingPen = drawingArea.getContext('2d');
            // ====================
            drawingPen.beginPath();
            for (var i = 1; i <= dataCount; ++i) {
                var curBarHeight = (yAxisBoxHeight / increaseNumber) * (Number(dataProduction[i]) - originNumber);
                var yCoordinate = padTop + yAxisLength - curBarHeight;
                var xCoordinate = padLeft + (i * xAxisBoxWidth);
                drawingPen.fillRect(xCoordinate - 18, yCoordinate, 36, curBarHeight);
                var txt = dataProduction[i];
                var txtWidth = drawingPen.measureText(txt).width;
                drawingPen.font = "12px Arial";
                drawingPen.fillText(txt, xCoordinate - txtWidth / 2, yCoordinate - 10);
            }
            drawingPen.stroke();
            drawingPen.closePath();
        }
        // ==============================
    </script>
</head>

<body>
    <form>
        年份：<input type="text" id="year"><br>
        产量：<input type="text" id="production">
        <button type="button" onclick="addData()"> 添加 </button>
    </form>

    <canvas id="drawingArea" width="1200" height="600"></canvas>

    <script>
        // 页面初始时先绘制的元素
        drawL();
        drawYScale();
        drawAxisTitle();
    </script>
</body>

</html>